<!DOCTYPE html>
<html>
<head>
    <title>DuckDB</title>
    <link rel="stylesheet" href="http://codemirror.net/lib/codemirror.css">
    <link rel="stylesheet" href="http://codemirror.net/addon/hint/show-hint.css">
    <link rel="stylesheet" href="./static/css/sortable-theme-bootstrap.css" />
    <link rel="stylesheet" href="./static/css/styles.css" />
    
    <script src="http://codemirror.net/lib/codemirror.js"></script>
    <script src="http://codemirror.net/addon/edit/matchbrackets.js"></script>
    <script src="http://codemirror.net/mode/sql/sql.js"></script>
    <script src="http://codemirror.net/addon/hint/show-hint.js"></script>
    <script src="http://codemirror.net/addon/hint/sql-hint.js"></script>
    <script src="http://pure.github.io/pure/libs/pure.js"></script>
    <script src="./static/js/sortable.js"></script>
</head>

<body>
<div>
    <h2>SQL Editer</h2>
    <button type="button" class="btn" style="float: left;" onclick="onClickPlay()"><img src="/static/images/play.svg" style="width: 15px; margin: 0;"></button>
    <textarea rows="4" cols="50" name="textarea_sql_editer" id="textarea_sql_editer">
    SELECT 1 AS 'Result' 
        UNION SELECT 2
        UNION SELECT 3
    </textarea>
    <table class="sortable-theme-bootstrap" data-sortable name="sortable_table" id="sortable_table">
        <thead id="thead">
        </thead>
        <tbody id="tbody">
        </tbody>
    </table>
</div>

<script>
    const libraryVersion = "0.0.41-dev180.0";
    const packageName = "@duckdb/duckdb-wasm";
    const distURL = "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@0.0.41-dev180.0/dist/";
    var db, sql_editer;

    DUCKDB_BUNDLES = ({
        asyncDefault: {
            mainModule: new URL('duckdb.wasm', distURL).toString(),
            mainWorker: new URL('duckdb-browser-async.worker.js', distURL).toString(),
        },
        asyncNext: {
            mainModule: new URL(`duckdb-next.wasm`, distURL).toString(),
            mainWorker: new URL('duckdb-browser-async-next.worker.js', distURL).toString(),
        },
        asyncNextCOI: {
            mainModule: new URL('duckdb-next-coi.wasm', distURL).toString(),
            mainWorker: new URL('duckdb-browser-async-next-coi.worker.js', distURL).toString(),
            pthreadWorker: new URL('duckdb-browser-async-next-coi.pthread.worker.js', distURL).toString(),
        },
    })

    async function makeDB() {
        const logger = new duckdb.ConsoleLogger();
        const worker = new Worker(workerURL);
        const db = new duckdb.AsyncDuckDB(logger, worker);
        await db.instantiate(wasmURL, pThreadURL);
        return db;
    }

    async function load() {
        duckdb = await import(`https://cdn.skypack.dev/${packageName}@${libraryVersion}`);
        bundle = await duckdb.selectBundle(DUCKDB_BUNDLES);

        // download worker script
        let workerReq = await fetch(bundle.mainWorker);
        let workerScript = await workerReq.text();
        let workerScriptBlob = new Blob([workerScript], { type: 'application/javascript' });
        workerURL = URL.createObjectURL(workerScriptBlob);

        // download WASM
        let wasmReq = await fetch(bundle.mainModule);
        wasmURL = URL.createObjectURL(await wasmReq.blob());

        // download Wasm
        if (!bundle.pthreadWorker) {
            pThreadURL = undefined;
        } else {
            let pthreadReq = await fetch(bundle.pthreadWorker);
            pThreadURL = URL.createObjectURL(await pthreadReq.blob());
        }

        const logger = new duckdb.ConsoleLogger();
        const worker = new Worker(workerURL);
        db = new duckdb.AsyncDuckDB(logger, worker);
        await db.instantiate(wasmURL, pThreadURL);
        console.log(db.getVersion());
    }

    async function test(db) {
        const conn = await db.connect();
        const result = await conn.runQuery(`SELECT 1 AS 'Result' UNION SELECT 11 UNION SELECT 22 UNION SELECT 111 UNION SELECT 222`);
        await conn.close();
        console.log(result);
    }

    window.onload = function () { 
        sql_editer = CodeMirror.fromTextArea(document.getElementById('textarea_sql_editer'), {
            mode: "text/x-mysql",
            lineNumbers: true,
            indentWithTabs: true,
            smartIndent: true,
            lineNumbers: true,
            matchBrackets : true,
            autofocus: true,
            extraKeys: {"Ctrl-Space": "autocomplete"},
            hintOptions: {tables: {
                users: {name: null, score: null, birthDate: null},
                countries: {name: null, population: null, size: null}
            }}
        });
        load();
    };

    function onClickPlay() {
        query = sql_editer.getValue()
        if (query) {
            run_query(query);
        }
    }

    async function run_query(query) {
        const conn = await db.connect();
        // const result = await conn.runQuery(query);
        const result = await conn.sendQuery(query);
        const batch = (await result.next()).value;
        await conn.close();
        load_data(batch)
    }

    function load_data(rows) {
        var thead = document.getElementById("thead");
        var tbody = document.getElementById("tbody");

        while (thead.hasChildNodes()) {
            thead.removeChild(thead.lastChild);
        }
        while (tbody.hasChildNodes()) {
            tbody.removeChild(tbody.lastChild);
        }

        var header_row = document.createElement("tr");
        var field_names = []
        for (let field of rows.schema.fields) {
            addCell(header_row, "th", `${field.name}`);
            field_names.push(field.name)
        }
        thead.appendChild(header_row);

        for (let row of rows) {
            var tr = document.createElement("tr");
            for (let f of field_names) {
                addCell(tr, "td", row[f]);
            }
            tbody.appendChild(tr);
        }

        Sortable.initTable(document.querySelector('#sortable_table'))
    }
    function addCell(tr, type, value) {
        var td = document.createElement(type)
        td.textContent = value;
        tr.appendChild(td);
    }
</script>
</html>